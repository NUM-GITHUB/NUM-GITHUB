<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="SiamMask NoteSiamMask is a model that is that I found very interesting recently. It is the model that can automatically mask an instance as long as an initial bounding boxes has been given you can fin">
<meta property="og:type" content="article">
<meta property="og:title" content="FengerBlog">
<meta property="og:url" content="https://num-github.github.io/2019/07/21/Review of SiamMask/index.html">
<meta property="og:site_name" content="FengerBlog">
<meta property="og:description" content="SiamMask NoteSiamMask is a model that is that I found very interesting recently. It is the model that can automatically mask an instance as long as an initial bounding boxes has been given you can fin">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://num-github.github.io/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563725602695.png">
<meta property="og:image" content="https://num-github.github.io/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563872260341.png">
<meta property="og:image" content="https://num-github.github.io/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563874125216.png">
<meta property="og:image" content="https://num-github.github.io/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563889858564.png">
<meta property="og:updated_time" content="2019-07-25T15:21:47.989Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FengerBlog">
<meta name="twitter:description" content="SiamMask NoteSiamMask is a model that is that I found very interesting recently. It is the model that can automatically mask an instance as long as an initial bounding boxes has been given you can fin">
<meta name="twitter:image" content="https://num-github.github.io/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563725602695.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>FengerBlog</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/07/25/Note for RPN/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/07/13/Investigation-for-Reinforcement-Learning-in-robotic/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Post Anterior</span>
      <span id="i-next" class="info" style="display:none;">Post Següent</span>
      <span id="i-top" class="info" style="display:none;">Adalt</span>
      <span id="i-share" class="info" style="display:none;">Compartir Post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://num-github.github.io/2019/07/21/Review of SiamMask/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&text="><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&is_video=false&description="><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=&body=Check out this article: https://num-github.github.io/2019/07/21/Review of SiamMask/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&name=&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#SiamMask-Note"><span class="toc-number">1.</span> <span class="toc-text">SiamMask Note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SiamFC"><span class="toc-number">1.1.</span> <span class="toc-text">SiamFC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#What’s-improved-on-siamMask"><span class="toc-number">1.1.1.</span> <span class="toc-text">What’s improved on siamMask</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SiamMask"><span class="toc-number">1.2.</span> <span class="toc-text">SiamMask</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SiamRPN"><span class="toc-number">1.3.</span> <span class="toc-text">SiamRPN</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Some-problems-that-I-thought"><span class="toc-number">1.3.1.</span> <span class="toc-text">Some problems that I thought:</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">FengerBlog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-07-21T16:52:35.170Z" itemprop="datePublished">2019-07-21</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="SiamMask-Note"><a href="#SiamMask-Note" class="headerlink" title="SiamMask Note"></a><a href="https://arxiv.org/pdf/1812.05050.pdf" target="_blank" rel="noopener">SiamMask</a> Note</h3><p><em>SiamMask is a model that is that I found very interesting recently. It is the model that can automatically mask an instance as long as an initial bounding boxes has been given you can find the code in github at <a href="https://github.com/foolwood/SiamMask" target="_blank" rel="noopener">here</a></em></p>
<p>In this article I will describe the development of siamMask based on its time line: from SiamFC, then SiamRPN, finally SiamMask</p>
<h4 id="SiamFC"><a href="#SiamFC" class="headerlink" title="SiamFC"></a>SiamFC</h4><p>SiamFC is the network for object tracking. The basic thinking for it is to continually compare the similarity between the first image and sliding windows from the last few images so as to generate a score map or <strong>RoW</strong> for similarity.</p>
<p><img src="/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563725602695.png" alt="1563725602695"></p>
<p>The mathematical expression for this SiamFC can be expressed as<br>$$<br>g_s(z,x)=f_e(z)*f_e(x)<br>$$<br>where z is the initial images, x is the next large images, $f_e(z) $ is embedding network and * simple cross-correlation. The training goal for this network is to maximize the score in score map to correspond to the target location is search area.</p>
<h5 id="What’s-improved-on-siamMask"><a href="#What’s-improved-on-siamMask" class="headerlink" title="What’s improved on siamMask"></a>What’s improved on siamMask</h5><p>For SiamMask, they improved the network architecture by output multi-channel score map rather than a single score map. Then, it replace simple cross-correlation with depth-wise cross-correlation which is a neural network. </p>
<h4 id="SiamMask"><a href="#SiamMask" class="headerlink" title="SiamMask"></a>SiamMask</h4><p>The architecture of SiamMask was shown blow</p>
<p><img src="/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563872260341.png" alt="1563872260341"></p>
<p>As you can see here, an mask and boxes part is added to the end of SiamMask. In this case, we just mainly talk about the mask part, the box and score is mainly proposed in SiamRPN.</p>
<p>More detailed architecture of it was shown in the next figure. The main <a href="https://github.com/foolwood/SiamMask" target="_blank" rel="noopener">code</a> is in custom.py. The code don’t have much comments, so I select some important code and add some comments for explanation in the following explanation.   </p>
<p><img src="/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563874125216.png" alt="1563874125216"></p>
<p>In the architecture above, the mask head was replaced by a refinement model which was inspired by <a href="https://arxiv.org/pdf/1603.08695.pdf" target="_blank" rel="noopener">this paper</a> which aim to refine the smaller mask to a bigger mask by using the features extracted from pervious convolution. </p>
<p>The whole architecture of it was written as shown below</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Custom</span><span class="params">(SiamMask)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, pretrain=False, **kwargs)</span>:</span></span><br><span class="line">        super(Custom, self).__init__(**kwargs)</span><br><span class="line">        <span class="comment">#tailored ResNet50+adjust layer</span></span><br><span class="line">        self.features = ResDown(pretrain=pretrain)</span><br><span class="line">        <span class="comment">#the parts for boundings boxes and classification (not discussed here, more detail are in SiamRPN)</span></span><br><span class="line">        self.rpn_model = UP(anchor_num=self.anchor_num, feature_in=<span class="number">256</span>, feature_out=<span class="number">256</span>)</span><br><span class="line">        <span class="comment">#Depth-wise correlation Maskcorr()&lt;-DepthCorr()</span></span><br><span class="line">        self.mask_model = MaskCorr()</span><br><span class="line">        <span class="comment">#Refinement part</span></span><br><span class="line">        self.refine_model = Refine()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">refine</span><span class="params">(self, f, pos=None)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.refine_model(f, pos)</span><br><span class="line">    </span><br><span class="line">	<span class="comment">#Embedding for the initialization image (the smaller 127×127×3 image z) for target.</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">template</span><span class="params">(self, template)</span>:</span></span><br><span class="line">        self.zf = self.features(template)</span><br><span class="line">        </span><br><span class="line">	<span class="comment">#For classification and bounding boxes</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">track</span><span class="params">(self, search)</span>:</span></span><br><span class="line">        search = self.features(search)</span><br><span class="line">        rpn_pred_cls, rpn_pred_loc = self.rpn(self.zf, search)</span><br><span class="line">        <span class="keyword">return</span> rpn_pred_cls, rpn_pred_loc</span><br><span class="line">	</span><br><span class="line">    <span class="comment">#The main archtecture  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">track_mask</span><span class="params">(self, search)</span>:</span></span><br><span class="line">        <span class="comment"># self.feature is the output feature extracted from ResNet at each layer stage</span></span><br><span class="line">        <span class="comment">#self.search is the output of adjust layer</span></span><br><span class="line">        self.feature, self.search = self.features.forward_all(search)</span><br><span class="line">        <span class="comment">#the parts for boundings boxes and classification (not discussed here, more detail are in SiamRPN)</span></span><br><span class="line">        rpn_pred_cls, rpn_pred_loc = self.rpn(self.zf, self.search)</span><br><span class="line">        <span class="comment">#Initialized embedding and the embedding for search image feed into depth-wise correlation without calling the head for generating mask</span></span><br><span class="line">        self.corr_feature = self.mask_model.mask.forward_corr(self.zf, self.search)</span><br><span class="line">        <span class="comment"># mask output without refinement (call mathod 'head' in DepthCorr())</span></span><br><span class="line">        pred_mask = self.mask_model.mask.head(self.corr_feature)</span><br><span class="line">        <span class="keyword">return</span> rpn_pred_cls, rpn_pred_loc, pred_mask</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">track_refine</span><span class="params">(self, pos)</span>:</span></span><br><span class="line">        <span class="comment"># mask output with refinement</span></span><br><span class="line">        pred_mask = self.refine_model(self.feature, self.corr_feature, pos=pos, test=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> pred_mask</span><br></pre></td></tr></table></figure>

<p>The embedding network is two ResNet50 with only the first four layers and then added an adjust layer to adjust channels. The important code for these two part  is shown in below (unnecessary code was deleted).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResDown</span><span class="params">(MultiStageFeature)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, pretrain=False)</span>:</span></span><br><span class="line">        super(ResDown, self).__init__()</span><br><span class="line">        self.features = resnet50(layer3=<span class="literal">True</span>, layer4=<span class="literal">False</span>)</span><br><span class="line">        self.downsample = ResDownS(<span class="number">1024</span>, <span class="number">256</span>)</span><br><span class="line"><span class="comment">#In forward or forward_all, the tailored Resnet50 and adjust layer (downsample) was connected</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        output = self.features(x)</span><br><span class="line">        p3 = self.downsample(output[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">return</span> p3 </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_all</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        output = self.features(x)</span><br><span class="line">        p3 = self.downsample(output[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">return</span> output, p3  </span><br><span class="line"><span class="comment">#The 'output' is the features extracted by ResNet and can be used of mask refinement.</span></span><br><span class="line"><span class="comment">#p3 is the embeding that will be feed into depth-wise correlation.</span></span><br></pre></td></tr></table></figure>

<p>The ‘output’ is the features extracted by ResNet and can be used of mask refinement, which consists the 3 features for refinement and one features for adjustment. The forward output of its ResNet is 4 values from each stage of ResNet.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">       ........</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">       x = self.conv1(x)</span><br><span class="line">       x = self.bn1(x)</span><br><span class="line">       p0 = self.relu(x)</span><br><span class="line">       x = self.maxpool(p0)</span><br><span class="line"></span><br><span class="line">       p1 = self.layer1(x)</span><br><span class="line">       p2 = self.layer2(p1)</span><br><span class="line">       p3 = self.layer3(p2)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> p0, p1, p2, p3</span><br></pre></td></tr></table></figure>

<p>p3 is the embedding that will be feed into depth-wise correlation.</p>
<p>In adjustment layer, one 1×1 kernel convolutional layer was applied with batch normalization.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResDownS</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplane, outplane)</span>:</span></span><br><span class="line">        super(ResDownS, self).__init__()</span><br><span class="line">        self.downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(inplane, outplane, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(outplane))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.downsample(x)</span><br><span class="line">        <span class="keyword">if</span> x.size(<span class="number">3</span>) &lt; <span class="number">20</span>:</span><br><span class="line">            l = <span class="number">4</span></span><br><span class="line">            r = <span class="number">-4</span></span><br><span class="line">            x = x[:, :, l:r, l:r]</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>

<p>Depth-wise correlation is still achieved with the architecture as below (the parameters of in_channels, hidden, out_channels are 256, 256, 63*63)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaskCorr</span><span class="params">(Mask)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, oSz=<span class="number">63</span>)</span>:</span></span><br><span class="line">        super(MaskCorr, self).__init__()</span><br><span class="line">        self.oSz = oSz</span><br><span class="line">        self.mask = DepthCorr(<span class="number">256</span>, <span class="number">256</span>, self.oSz**<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, z, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.mask(z, x)</span><br></pre></td></tr></table></figure>

<p>DepthCorr called by  MaskCorr.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv2d_dw_group</span><span class="params">(x, kernel)</span>:</span></span><br><span class="line">    batch, channel = kernel.shape[:<span class="number">2</span>]</span><br><span class="line">    x = x.view(<span class="number">1</span>, batch*channel, x.size(<span class="number">2</span>), x.size(<span class="number">3</span>))  <span class="comment"># 1 * (b*c) * k * k</span></span><br><span class="line">    kernel = kernel.view(batch*channel, <span class="number">1</span>, kernel.size(<span class="number">2</span>), kernel.size(<span class="number">3</span>))  <span class="comment"># (b*c) * 1 * H * W</span></span><br><span class="line">    out = F.conv2d(x, kernel, groups=batch*channel)</span><br><span class="line">    out = out.view(batch, channel, out.size(<span class="number">2</span>), out.size(<span class="number">3</span>))</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DepthCorr</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, hidden, out_channels, kernel_size=<span class="number">3</span>)</span>:</span></span><br><span class="line">        super(DepthCorr, self).__init__()</span><br><span class="line">        <span class="comment"># adjust layer for asymmetrical features</span></span><br><span class="line">        self.conv_kernel = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels, hidden, kernel_size=kernel_size, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(hidden),</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                )</span><br><span class="line">        self.conv_search = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels, hidden, kernel_size=kernel_size, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(hidden),</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                )</span><br><span class="line">		<span class="comment">#mask head</span></span><br><span class="line">        self.head = nn.Sequential(</span><br><span class="line">                nn.Conv2d(hidden, hidden, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(hidden),</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                nn.Conv2d(hidden, out_channels, kernel_size=<span class="number">1</span>)</span><br><span class="line">                )</span><br><span class="line">	<span class="comment">#output without adding mask head</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_corr</span><span class="params">(self, kernel, input)</span>:</span></span><br><span class="line">        kernel = self.conv_kernel(kernel)</span><br><span class="line">        input = self.conv_search(input)</span><br><span class="line">        feature = conv2d_dw_group(input, kernel)</span><br><span class="line">        <span class="keyword">return</span> feature</span><br><span class="line">	<span class="comment">#output with mask head</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, kernel, search)</span>:</span></span><br><span class="line">        feature = self.forward_corr(kernel, search)</span><br><span class="line">        out = self.head(feature)</span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>

<p>In Refinement stage, you can clearly see the structure: deconvolute the output from depth-wise convolution and the three stage refinement in last few lines of forward method.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Refine</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Refine, self).__init__()</span><br><span class="line">        self.v0 = nn.Sequential(nn.Conv2d(<span class="number">64</span>, <span class="number">16</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">                           nn.Conv2d(<span class="number">16</span>, <span class="number">4</span>, <span class="number">3</span>, padding=<span class="number">1</span>),nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.v1 = nn.Sequential(nn.Conv2d(<span class="number">256</span>, <span class="number">64</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">                           nn.Conv2d(<span class="number">64</span>, <span class="number">16</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.v2 = nn.Sequential(nn.Conv2d(<span class="number">512</span>, <span class="number">128</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">                           nn.Conv2d(<span class="number">128</span>, <span class="number">32</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.h2 = nn.Sequential(nn.Conv2d(<span class="number">32</span>, <span class="number">32</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">                           nn.Conv2d(<span class="number">32</span>, <span class="number">32</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.h1 = nn.Sequential(nn.Conv2d(<span class="number">16</span>, <span class="number">16</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">                           nn.Conv2d(<span class="number">16</span>, <span class="number">16</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.h0 = nn.Sequential(nn.Conv2d(<span class="number">4</span>, <span class="number">4</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU(),</span><br><span class="line">                           nn.Conv2d(<span class="number">4</span>, <span class="number">4</span>, <span class="number">3</span>, padding=<span class="number">1</span>), nn.ReLU())</span><br><span class="line"></span><br><span class="line">        self.deconv = nn.ConvTranspose2d(<span class="number">256</span>, <span class="number">32</span>, <span class="number">15</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">        self.post0 = nn.Conv2d(<span class="number">32</span>, <span class="number">16</span>, <span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.post1 = nn.Conv2d(<span class="number">16</span>, <span class="number">4</span>, <span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.post2 = nn.Conv2d(<span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> modules <span class="keyword">in</span> [self.v0, self.v1, self.v2, self.h2, self.h1, self.h0, self.deconv, self.post0, self.post1, self.post2,]:</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> modules.modules():</span><br><span class="line">                <span class="keyword">if</span> isinstance(l, nn.Conv2d):</span><br><span class="line">                    nn.init.kaiming_uniform_(l.weight, a=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, f, corr_feature, pos=None, test=False)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> test:</span><br><span class="line">            p0 = torch.nn.functional.pad(f[<span class="number">0</span>], [<span class="number">16</span>, <span class="number">16</span>, <span class="number">16</span>, <span class="number">16</span>])[:, :, <span class="number">4</span>*pos[<span class="number">0</span>]:<span class="number">4</span>*pos[<span class="number">0</span>]+<span class="number">61</span>, <span class="number">4</span>*pos[<span class="number">1</span>]:<span class="number">4</span>*pos[<span class="number">1</span>]+<span class="number">61</span>]</span><br><span class="line">            p1 = torch.nn.functional.pad(f[<span class="number">1</span>], [<span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>])[:, :, <span class="number">2</span> * pos[<span class="number">0</span>]:<span class="number">2</span> * pos[<span class="number">0</span>] + <span class="number">31</span>, <span class="number">2</span> * pos[<span class="number">1</span>]:<span class="number">2</span> * pos[<span class="number">1</span>] + <span class="number">31</span>]</span><br><span class="line">            p2 = torch.nn.functional.pad(f[<span class="number">2</span>], [<span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>])[:, :, pos[<span class="number">0</span>]:pos[<span class="number">0</span>] + <span class="number">15</span>, pos[<span class="number">1</span>]:pos[<span class="number">1</span>] + <span class="number">15</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p0 = F.unfold(f[<span class="number">0</span>], (<span class="number">61</span>, <span class="number">61</span>), padding=<span class="number">0</span>, stride=<span class="number">4</span>).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>).contiguous().view(<span class="number">-1</span>, <span class="number">64</span>, <span class="number">61</span>, <span class="number">61</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (pos <span class="keyword">is</span> <span class="literal">None</span>): p0 = torch.index_select(p0, <span class="number">0</span>, pos)</span><br><span class="line">            p1 = F.unfold(f[<span class="number">1</span>], (<span class="number">31</span>, <span class="number">31</span>), padding=<span class="number">0</span>, stride=<span class="number">2</span>).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>).contiguous().view(<span class="number">-1</span>, <span class="number">256</span>, <span class="number">31</span>, <span class="number">31</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (pos <span class="keyword">is</span> <span class="literal">None</span>): p1 = torch.index_select(p1, <span class="number">0</span>, pos)</span><br><span class="line">            p2 = F.unfold(f[<span class="number">2</span>], (<span class="number">15</span>, <span class="number">15</span>), padding=<span class="number">0</span>, stride=<span class="number">1</span>).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>).contiguous().view(<span class="number">-1</span>, <span class="number">512</span>, <span class="number">15</span>, <span class="number">15</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (pos <span class="keyword">is</span> <span class="literal">None</span>): p2 = torch.index_select(p2, <span class="number">0</span>, pos)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span>(pos <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">            p3 = corr_feature[:, :, pos[<span class="number">0</span>], pos[<span class="number">1</span>]].view(<span class="number">-1</span>, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p3 = corr_feature.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).contiguous().view(<span class="number">-1</span>, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">##################The structure of refinement. ##################################</span></span><br><span class="line">        out = self.deconv(p3)</span><br><span class="line">        out = self.post0(F.upsample(self.h2(out) + self.v2(p2), size=(<span class="number">31</span>, <span class="number">31</span>)))</span><br><span class="line">        out = self.post1(F.upsample(self.h1(out) + self.v1(p1), size=(<span class="number">61</span>, <span class="number">61</span>)))</span><br><span class="line">        out = self.post2(F.upsample(self.h0(out) + self.v0(p0), size=(<span class="number">127</span>, <span class="number">127</span>)))</span><br><span class="line">        out = out.view(<span class="number">-1</span>, <span class="number">127</span>*<span class="number">127</span>)</span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>

<p>Loss function</p>
<h4 id="SiamRPN"><a href="#SiamRPN" class="headerlink" title="SiamRPN"></a>SiamRPN</h4><p>Ok, after talking about SiamMask, let’s move on to the parts about classification and bounding box predication. The original figure of siamRPN is the figure shown below, although the later version siamRPN++ has some modified version of it, but I think the following diagram is clear enough to show the core thinking of it. </p>
<p><img src="/.io//C:%5CUsers%5Ca%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1563889858564.png" alt="1563889858564"></p>
<p>Basically, what SiamRPN doing in SiamMask input the two features from a network, in this case, ResNet,  and pass them to classification block and regression block. Then, in these two block, the  the depth-wise correlation will be calculated and gives a series of classification groups and regression groups to determine the bounding boxes. </p>
<h5 id="Some-problems-that-I-thought"><a href="#Some-problems-that-I-thought" class="headerlink" title="Some problems that I thought:"></a>Some problems that I thought:</h5><p>This model don’t have the function for memory, I think it would be better to add some technique like RNN to update the embedding. </p>
<p>It only initialize the image but not mask, so the quality of tracking high affected by the first image and in some cases, you cannot initialize an object that with a rectangles.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#SiamMask-Note"><span class="toc-number">1.</span> <span class="toc-text">SiamMask Note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SiamFC"><span class="toc-number">1.1.</span> <span class="toc-text">SiamFC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#What’s-improved-on-siamMask"><span class="toc-number">1.1.1.</span> <span class="toc-text">What’s improved on siamMask</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SiamMask"><span class="toc-number">1.2.</span> <span class="toc-text">SiamMask</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SiamRPN"><span class="toc-number">1.3.</span> <span class="toc-text">SiamRPN</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Some-problems-that-I-thought"><span class="toc-number">1.3.1.</span> <span class="toc-text">Some problems that I thought:</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://num-github.github.io/2019/07/21/Review of SiamMask/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&text="><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&is_video=false&description="><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=&body=Check out this article: https://num-github.github.io/2019/07/21/Review of SiamMask/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&title="><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://num-github.github.io/2019/07/21/Review of SiamMask/&name=&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menú</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Compartir</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Cap amunt</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Fenger
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
